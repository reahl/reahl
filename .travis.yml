sudo: false

env:
  global:
    - PGPASSWORD=rhug     # TODO: need to remove the PGPASSWORD, rather use .pgpass method
    - REAHLWORKSPACE=$HOME
    - EMAIL=noone@example.org
    - DEBFULLNAME="Travis Tester"
    - DEBEMAIL=$EMAIL
    - PACKAGESIGNKEYID=DE633F86
    - DISPLAY=:99.0

addons:
#  postgresql: "9.4"
  apt:
    packages:
       # Basic apt dependencies
        - equivs 
        - openssh-client 
        - dpkg-dev
        - bzr
        - git
#        - chromium-browser       # Already installed on travis
#        - chromium-chromedriver  # Not whitelisted, not in apt repository for precise

       # For compiling pip installed extensions we use
        - python-virtualenv
        - python-dev
        - gcc
        - cython
        - libxml2-dev
        # - libxslt-dev   # not allowed in apt addon
        - libsqlite3-0
        - sqlite3
        - postgresql-server-dev-9.1
        - zlib1g-dev
        - libjpeg62-dev
        - libfreetype6-dev
        - liblcms1-dev
        - phantomjs  

services:
  - postgresql

language: python
python:
  - 3.4
#  - 2.7

before_install: 
  # Install stuff we can't install with apt addon
  - "mkdir ~/bin"
  - "wget -O - http://chromedriver.storage.googleapis.com/2.24/chromedriver_linux64.zip | gunzip -c > ~/bin/chromedriver" 
  - "chmod u+x ~/bin/chromedriver"
  - "export PATH=$PATH:$HOME/bin"

  # Import weak key used for testing
  - "gpg --import travis/testkey.public.asc travis/testkey.secret.asc"
  - "gpg --import-ownertrust < travis/testkey.trust.asc"
  - "gpg --list-keys"
  - "gpg --list-secret-keys"

  # Make git happy
  - git config --global user.email $EMAIL
  - git config --global user.name "$DEBFULLNAME"
  - git --version

  - firefox --version
  - wires --version
  
install:
  - "python scripts/bootstrap.py --script-dependencies"
  - CFLAGS="-O0" python scripts/bootstrap.py --pip-installs
  - "reahl-control createdbuser reahl-web/etc/"
  - "reahl-control createdb reahl-web/etc/"
  - "reahl setup -sX -- develop -N"

before_script:
  # Set up headless display for browsers
  #- "export DISPLAY=:99.0" #
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start

  # Setup ssh for password-less access to localhost
  - ssh-keygen -f ~/.ssh/id_rsa -N ""
  - cp ~/.ssh/{id_rsa.pub,authorized_keys}

  - eval $(ssh-agent)
  - ssh-add

  - ssh -o StrictHostKeyChecking=no localhost ls


script:
  - "reahl shell -sdX -- reahl unit -- --with-long-output"


